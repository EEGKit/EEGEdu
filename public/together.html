<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>EEGEdu</title>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js" integrity="sha256-s4pCizM36ibu/qMLSJHZLwhA5sV0/Jn1J/1TrzryEKQ=" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@4.9.0/styles.min.css" />
  </head
  >
  <body>
    <div id="together">
      <h1>
        Start streaming data from subscribers
      </h1>
      <p>Plots will appear for each user connected:</p>

      <canvas id="mycanvas1" width="100" height="100"></canvas>
      <canvas id="mycanvas2" width="100" height="100"></canvas>
      <canvas id="mycanvas3" width="100" height="100"></canvas>
      <canvas id="mycanvas4" width="100" height="100"></canvas>
      <canvas id="mycanvas5" width="100" height="100"></canvas>
      <canvas id="mycanvas6" width="100" height="100"></canvas>
      <canvas id="mycanvas7" width="100" height="100"></canvas>
      <canvas id="mycanvas8" width="100" height="100"></canvas>

      <ul id="messages"></ul>
    </div>

    <script>
      var allData = {};
      var allCharts = {};
      var userCount = 0;
    </script>
    <script>
      $(function () {
        var socket = io();
        console.log('socket details', socket);
        socket.on('outgoing data', function (data) {

          var user = data['num']['userName'];
          var reading = data['num']['psd'][0][10];

          if (!allData[user]) {
            userCount++ 
            allData[user] = new TimeSeries();

            allCharts[user] = new SmoothieChart({ millisPerPixel: 88, minValue: 0, maxValue: 20, grid: { strokeStyle: 'rgb(125, 0, 0)', fillStyle: 'rgb(60, 0, 0)', lineWidth: 1, millisPerLine: 250, verticalSections: 6 } });
            allCharts[user].streamTo(document.getElementById("mycanvas" + userCount), 1000);
            thisColour = 'hsl(' + Math.floor(Math.random() * 255) + ', 99%, 50%)';
            allCharts[user].addTimeSeries(allData[user], {strokeStyle: thisColour, fillStyle: thisColour});
            console.log('Welcome new user ' + user)
          }

          allData[user].append(new Date().getTime(), reading);
          $('#messages').prepend($('<li>').text(`[${user}]: ${reading} `));
          console.log(data['num']['userName']);
        });
      });
    </script>
  </body>
</html>
